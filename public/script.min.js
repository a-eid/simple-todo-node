'use strict';

var d = window.document;
var $ = d.querySelector.bind(document);
var $$ = d.querySelectorAll.bind(document);
var l = console.log.bind(console);

Node.prototype.on = window.on = function (name, fn) {
  this.addEventListener(name, fn);
};

NodeList.prototype.__proto__ = Array.prototype; // eslint-disable-line

NodeList.prototype.on = NodeList.prototype.addEventListener = function (name, fn) {
  this.forEach(function (elem) {
    elem.on(name, fn);
  });
};

var base_url = 'http://localhost:3000/todos';
var ul = void 0;

var init = function init() {
  console.log('init app'
  // ul && ul.remove() 
  );fetch(base_url).then(function (ts) {
    return ts.json();
  }).then(function (ts) {
    renderTodos(ts);
    console.log(ts);
  });
};

$('#addtodo').on('keyup', function (e) {
  e.preventDefault();
  if (e.keyCode != 13) return;
  var todo = {
    name: $('#addtodo').value,
    completed: $('#done').checked
  };

  fetch(base_url, {
    method: 'POST',
    body: JSON.stringify(todo),
    headers: {
      "Content-type": 'application/json',
      "accept": "application/json"
    }
  }).then(function (t) {
    return t.json();
  }).then(function (t) {
    renderTodo(t);
    clearForm();
  }).catch(function (e) {
    return console.log(e);
  });
});

var renderTodos = function renderTodos(todos) {
  ul = d.createElement('ul');
  $('.todos').appendChild(ul);
  todos.forEach(function (t) {
    console.log(t);
    renderTodo(t);
  });
};

var renderTodo = function renderTodo(t) {
  if (t.message) {
    t = t.todo;
  }
  var li = d.createElement('li');
  var text = d.createTextNode(t.name);
  li.appendChild(text);
  li.setAttribute('data-id', t.id);
  t.completed && (li.style.textDecoration = 'line-through');
  li.on('click', toggleTodo);
  ul.appendChild(li);
};

var updateTodo = function updateTodo(id, todo) {
  console.log(id);
  var todoEl = $('[data-id="' + id + '"]');
  console.log(todo.name, todo.completed);
  todoEl.textContent = todo.name;
  todoEl.style.textDecoration = todo.completed ? "line-through" : "none";
};

var clearForm = function clearForm() {
  var input = $('#addtodo');
  $('#done').checked = false;
  input.value = "";
  input.disabled = true;
  setTimeout(function (_) {
    input.disabled = false;
    input.focus();
  }, 1500);
};

function toggleTodo(e) {
  var crossed = this.style.textDecoration == 'line-through';
  var id = this.getAttribute('data-id');
  fetch(base_url + '/' + id + '/toggle', {
    method: 'post',
    body: JSON.stringify({ id: id, completed: !crossed }),
    headers: {
      "Content-type": 'application/json',
      "accept": "application/json"
    }
  }).then(function (t) {
    return t.json();
  }).then(function (t) {
    updateTodo(id, t.todo ? t.todo : t);
  }).catch(function (e) {
    return console.log(e);
  });
}

init();
